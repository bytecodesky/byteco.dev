---
// Component to add copy buttons to code blocks client-side
---

<script>
  function initCodeBlocks() {
    // Find all pre elements with code
    const codeBlocks = document.querySelectorAll('.prose pre');
    
    codeBlocks.forEach((pre, index) => {
      // Skip if already wrapped
      if (pre.parentElement?.classList.contains('code-block-wrapper')) return;
      
      // Get the language from code element's class
      const codeEl = pre.querySelector('code');
      const classList = codeEl?.className || '';
      const langMatch = classList.match(/language-([a-zA-Z0-9-_]+)/);
      const lang = langMatch ? langMatch[1] : 'text';
      
      // Create outer wrapper with glass effect
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      
      // Create header with language label and copy button
      const header = document.createElement('div');
      header.className = 'code-block-header';
      header.innerHTML = `
        <span class="code-language-label">${lang}</span>
        <button class="code-copy-button" aria-label="Copy code to clipboard">
          <svg class="copy-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          <svg class="check-icon hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span class="copy-text">Copy</span>
          <span class="copied-text hidden">Copied!</span>
        </button>
      `;
      
      // Wrap the pre element
      if (pre.parentNode) {
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(header);
        wrapper.appendChild(pre);
      }
      
      // Add click handler
      const button = header.querySelector('.code-copy-button');
      button?.addEventListener('click', async () => {
        const code = codeEl?.textContent || '';
        
        try {
          await navigator.clipboard.writeText(code);
          
          // Show feedback
          const copyIcon = button.querySelector('.copy-icon');
          const checkIcon = button.querySelector('.check-icon');
          const copyText = button.querySelector('.copy-text');
          const copiedText = button.querySelector('.copied-text');
          
          copyIcon?.classList.add('hidden');
          checkIcon?.classList.remove('hidden');
          copyText?.classList.add('hidden');
          copiedText?.classList.remove('hidden');
          
          // Reset after 2 seconds
          setTimeout(() => {
            copyIcon?.classList.remove('hidden');
            checkIcon?.classList.add('hidden');
            copyText?.classList.remove('hidden');
            copiedText?.classList.add('hidden');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  }
  
  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCodeBlocks);
  } else {
    initCodeBlocks();
  }
  
  // Re-run on navigation (for view transitions)
  document.addEventListener('astro:page-load', initCodeBlocks);
</script>

<style is:global>
  /* Outer glass wrapper for code blocks */
  .code-block-wrapper {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    border-radius: 0.5rem;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0.04));
    border: 1px solid rgba(255, 255, 255, 0.14);
    box-shadow: 0 24px 70px rgba(0, 0, 0, 0.65), inset 0 1px 0 rgba(255, 255, 255, 0.10);
    backdrop-filter: blur(20px) saturate(140%);
    -webkit-backdrop-filter: blur(20px) saturate(140%);
    overflow: hidden;
  }

  /* Header with language label and copy button */
  .code-block-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.625rem 0.75rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.03);
  }

  .code-language-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgb(var(--color-text-tertiary));
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  .code-copy-button {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: rgb(var(--color-text-secondary));
    background: rgba(var(--color-glass-bg), 0.05);
    border: 1px solid rgba(var(--color-glass-border), 0.1);
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .code-copy-button:hover {
    color: rgb(var(--color-text-primary));
    background: rgba(var(--color-glass-bg), 0.08);
    border-color: rgba(var(--color-glass-border), 0.15);
  }

  .code-copy-button:active {
    transform: scale(0.98);
  }

  .hidden {
    display: none;
  }
</style>
