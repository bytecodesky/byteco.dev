---
import { type CollectionEntry, getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import TagList from '../../components/TagList.astro';
import { formatDate, getReadingTime } from '../../utils/helpers';
import { getAllBlogPosts, getRelatedPosts } from '../../lib/content';
import { ArrowLeft } from 'lucide-astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content, headings } = await post.render();
const { title, description, date, tags } = post.data;

const allPosts = await getAllBlogPosts();
const relatedPosts = getRelatedPosts(post, allPosts);

// Get reading time from the rendered content
const readingTime = getReadingTime(post.body);
---

<BaseLayout
  title={`${title} - byteco.dev`}
  description={description}
  article={true}
  publishedTime={date}
  tags={tags}
>
  <article class="container mx-auto px-8 py-16 max-w-5xl">
    <header class="mb-12">
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-[rgb(var(--color-text-tertiary))] hover:text-[rgb(var(--color-text-primary))] transition-colors mb-8"
      >
        <ArrowLeft size={20} />
        Back to Blog
      </a>
      
      <h1 class="text-5xl font-bold mb-6 text-[rgb(var(--color-text-primary))] leading-tight">
        {title}
      </h1>
      <p class="text-xl text-[rgb(var(--color-text-secondary))] mb-6 leading-relaxed">
        {description}
      </p>
      <div class="flex items-center gap-4 text-sm text-[rgb(var(--color-text-tertiary))]">
        <time datetime={date.toISOString()}>
          {formatDate(date)}
        </time>
        <span>â€¢</span>
        <span>{readingTime}</span>
      </div>
      {tags.length > 0 && (
        <div class="mt-6">
          <TagList tags={tags} />
        </div>
      )}
    </header>

    <div class="grid md:grid-cols-[1fr_280px] gap-12">
      <div class="glass-card p-8 md:p-12">
        <div class="prose">
          <Content />
        </div>
      </div>
      <aside class="hidden md:block">
        <div class="sticky top-8">
          <TableOfContents headings={headings} />
        </div>
      </aside>
    </div>

    <RelatedPosts posts={relatedPosts} />
  </article>
</BaseLayout>
