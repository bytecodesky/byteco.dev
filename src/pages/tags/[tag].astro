---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import NoteCard from '../../components/NoteCard.astro';
import { getAllTags, getPostsByTag, getNotesByTag } from '../../lib/content';
import { ArrowLeft, Tag, FileText, BookOpen } from 'lucide-astro';

export async function getStaticPaths() {
  const tagCounts = await getAllTags();
  return Array.from(tagCounts.keys()).map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;

// Validate tag parameter
if (!tag || typeof tag !== 'string') {
  return Astro.redirect('/tags');
}

const posts = await getPostsByTag(tag);
const notes = await getNotesByTag(tag);
const totalCount = posts.length + notes.length;
---

<BaseLayout
  title={`#${tag} - byteco.dev`}
  description={`Posts and notes tagged with ${tag}`}
>
  <div class="container mx-auto px-8 py-16">
    <header class="mb-16">
      <a
        href="/tags"
        class="inline-flex items-center gap-2 text-[rgb(var(--color-text-tertiary))] hover:text-[rgb(var(--color-accent))] transition-colors mb-8"
      >
        <ArrowLeft size={20} />
        Back to Tags
      </a>
      
      <div class="flex items-center gap-4 mb-6">
        <Tag size={40} class="text-[rgb(var(--color-accent))]" />
        <h1 class="text-5xl font-bold text-[rgb(var(--color-text-primary))]">
          <span class="text-[rgb(var(--color-accent))]">#{tag}</span>
        </h1>
      </div>
      <p class="text-xl text-[rgb(var(--color-text-secondary))]">
        {totalCount} {totalCount === 1 ? 'item' : 'items'} tagged with {tag}
      </p>
    </header>

    {posts.length > 0 && (
      <section class="mb-16">
        <h2 class="text-3xl font-bold mb-8 text-[rgb(var(--color-text-primary))] flex items-center gap-3">
          <FileText size={28} class="text-[rgb(var(--color-accent))]" />
          Blog Posts ({posts.length})
        </h2>
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {posts.map((post) => (
            <BlogPostCard post={post} />
          ))}
        </div>
      </section>
    )}

    {notes.length > 0 && (
      <section>
        <h2 class="text-3xl font-bold mb-8 text-[rgb(var(--color-text-primary))] flex items-center gap-3">
          <BookOpen size={28} class="text-[rgb(var(--color-accent))]" />
          Notes ({notes.length})
        </h2>
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {notes.map((note) => (
            <NoteCard note={note} />
          ))}
        </div>
      </section>
    )}

    {totalCount === 0 && (
      <div class="glass-card p-12 text-center">
        <p class="text-lg text-[rgb(var(--color-text-tertiary))]">No content found with this tag.</p>
      </div>
    )}
  </div>
</BaseLayout>
